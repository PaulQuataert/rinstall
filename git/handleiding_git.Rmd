---
title: "Starten met git"
author: "Thierry Onkelinx"
date: "03-02-2015"
bibliography: "~/local_tex/bibtex/bib/git.bib"
output: html_document
---

# Starten met git

- Ga na of git geïnstalleerd is. Volgens de BMK instructies moet dat in `c:\R\git`
- Ga na op git geconfigureerd is in RStudio. 
    - Ga naar `Tools` -> `Global options`
    - Open het tabblad `Git/SVN`
    - Zorg dat hier verwijzing naar de git executable correct staat
- Typografie
    - `RStudio namen, knoppen, opties, items in menubalken, ...`
    - `shell commando's`
    - _git gerelateerde termen_
    - **namen van git branches**


















## Eenvoudig nieuw project enkel lokaal

### Een project starten

- Kies in RStudio voor `File` -> `New project` -> `Empty project`.
    - Vul de gewenste naam van het project in en de gewenste directory waarin het project moet komen.
    - Vink `create a git repository` aan.
    - Klik  `Create repository`
    - Het nieuwe project wordt nu geopent
- RStudio voegt een tabblad `Git` toe aan de editor. In dit tabblad doe je alle bewerkingen gerelateerd aan het versiebeheer
    - Je vindt er steeds een overzicht van de status van alle bestanden m.b.t. versiebeheer
    - Op dit moment zal je er twee bestanden vinden: `.gitignore` en `jouw_project.Rproj`
    - In de kolom `Status` zie je twee keer een vraagteken in een geel veld. Dat wijst op een _untracked_ bestand. Dergelijke bestanden worden genegeerd door het versiebeheer. Merk op dat geen enkel bestand automatisch wordt opgenomen in het versiebeheer.
- Klik rechts op `jouw_project.Rproj` en kies `ignore`. Nu open een beknopte editor met de inhoud van `.gitignore`. Hier geef je de namen van de bestanden of mappen weer die git standaard moet genegeren. Een _ignored_ bestand wordt, net zoals een _untracked_ bestand niet opgenomen in het versiebeheer. Het verschil tussen beide is dat _ignored_ bestanden niet zichtbaar zullen zijn in het `Git` tabblad.
    - Wijzig `jouw_project.Rproj` in `*.Proj` en klik op `Save` Vanaf nu zullen alle bestanden die eindigen met `.Proj` de _ignored_ status krijgen. Merk op dat `jouw_project.Rproj` nu uit het `Git` tabblad verdwenen is.
    - Regel uit `.gitignore` wissen = _ignore_ ongedaan maken.
- Wanneer _ignore_ gebruiken
    - Vuistregel: telkens je het bestand in kwestie makkelijk kan aanmaken met de gegevens in de repository
    - Bijvoorbeeld: figuren, pdf, md en tex bestanden die ontstaan na het compileren van een RMarkdown (.Rmd) bestand
    - RStudio vult standaard `.Rproj.user`, `.Rhistory` en `.RData`. `.Rproj.user` is de map met alle tijdelijke bestanden van het project. `.Rhistory` bevat een lijst van alle commando's die je uitvoert. `.RData` zijn de objecten in de workspace. Deze bestanden zijn niet relevant om onder versiebeheer te plaatsen.
    - Best ook `*.Rproj`. Je krijgt anders problemen wanneer het project vanop meerdere computers gebruikt wordt.
- `.gitignore` plaats je best onder versiebeheer. Op die manier zal iedereen dezelfde bestanden _ignoren_.
- Nu maken we een eerste _commit_. Een _commit_ is een snapshot van de versie van de bestanden op dat ogenblik. De eerste stap bij het maken van een _commit_ is bepalen welke gewijzigde bestanden relevant zijn om op te nemen in de _commit_. Merk op dat het niet noodzakelijk is om alle gewijzigde bestanden op te nemen in een _commit_.
    - Je moet eerst de gewenste bestanden _stagen_ = klaarzetten om op te nemen in de snapshot. Dat doe je door `Staged` aan te vinken voor de naam van het bestand. Doe dit met `.gitignore`. Door te _stagen_ verandert de status van _untracked_ bestanden naar _added_, aangegeven door een "A" op een turkoois veld in de linkerhelft van de `Status` kolom.
    - Door `Staged` terug uit te vinken herstel je de status van het bestand naar de vorige status.
- Eens alle gewenste bestanden _gestaged_ zijn, kan je _committen_ door op de knop _commit_ te klikken.
    - Nu opent een venster met heel wat informatie over de wijzigingen.
    - Je krijgt een venster met de betrokken bestanden. Hier kan je nog wijzigingen aanbrengen zoals in het `Git tabblad` (_stage_, _unstage_, _ignore_)
    - Onderaan krijg je de _diff_ te zien van het bestand. Groene regels zijn toegevoegd, rode regels zijn gewist, witte regels zijn ongewijzigd.
        - In de _diff_ worden standaard enkel de 5 ongewijzigde regels voor en naar een wijziging getoond. Ook een enkel wijziging aan het einde van een lang bestand zie je op die manier dadelijk.
        - De hoeveelheid context kan je aanpassen via de dropdrop `Context` (5, 10, 25, 50 of alle lijnen)
        - De _Diff_ is deze van het geselecteerd bestand. Klik op de bestandsnaam om een ander bestand te selecteren.
        - Een _Diff_ werkt enkel bij bestanden met platte tekst. Niet met binaire bestanden (pdf, docx, jpg, Rdata, ...)
    - Naast de lijst met bestanden staat een tekstveld `Commit message`. Hierin moet je een tekst schrijven. Deze tekst beschrijft de wijzigingen in deze _commit_.
        - Een goede _commit message_ is cruciaal. Het is de enige manier om later te weten waarom je een bepaalde wijzigingen aanbracht.
    - `Amend previous commit` kan je gebruiken indien je een bestand vergeten te _stagen_ en je wilt het alsnog toevoegen aan de vorige _commit_.
    - Als je klaar bent (= alle gewenste bestanden _gestaged_ en een goede _commit message_ geschreven), dan kan je op `Commit` klikken. Je krijgt dan een nieuw venster met een beknopt overzicht van de wijzigingen. Klik op `Close` om het af te sluiten. Je kan vervolgens het `Commit` venster sluiten.
    - De _gestagede_ bestanden zijn nu verdwenen uit het `Git` tabblad.

- Maak bovenstaand RStudio project
- Plak onderstaande code in `script1.R`

```{r script1}
library(ggplot2)
ggplot(mtcars, aes(wt, mpg)) + geom_point()
```

- Plak onderstaande code in `script2.R`

```{r script2}
ctl <- c(4.17,5.58,5.18,6.11,4.50,4.61,5.17,4.53,5.33,5.14)
trt <- c(4.81,4.17,4.41,3.59,5.87,3.83,6.03,4.89,4.32,4.69)
group <- gl(2, 10, 20, labels = c("Ctl","Trt"))
weight <- c(ctl, trt)
lm.D9 <- lm(weight ~ group)

anova(lm.D9)
summary(lm.D9)
```

- _Stage_ `script1.R` en _commit_.
- _Stage_ `script2.R` en _commit_ met de `Amend previous commit` optie aangevinkt.




















### Bestaande bestanden wijzigen

- Van zodra een bestand na een commit gewijzigd wordt, zal git het terug automatisch in het `Git` tabblad tonen.
    - De status van dergelijke bestanden is _unstaged modified_ aangegeven door een "M" op een blauw veld in de rechter kolom van `Status`.
- Wanneer we nu een snapshot willen maken van de de huidige versie, moeten we de gewijzigde bestanden opnieuw _stagen_.
    - Behalve het vinkje in `Staged` zal ook de "M" in `Status` verplaatsen naar de linker kolom (_staged modified_).
    - Het bestand is nu gewijzigd én de wijzigingen zijn klaar voor een _commit_. OOk nu worden de wijzigingen past toegevoegd aan het versiebeheer na een _commit_!

- Wijzig `script1.R` naar

```{r script1_1, eval = FALSE}
library(ggplot2)
p <- ggplot(mtcars, aes(wt, mpg)) + geom_point()
ggsave(p, file = "script1.jpg")
```
- Voer `script1.R` uit
- _Stage_ `script1.R`
- Wijzig `script1.R` naar

```{r script1_2, eval = FALSE}
library(ggplot2)
p <- ggplot(mtcars, aes(wt, mpg)) + geom_point()
ggsave(p, file = "script1.png")
```

- Merk dat we `script1.R` gewijzigd hebben, vervolgens _gestaged_ en dan weer gewijzigd terwijl we nog geen _commit_ gedaan hebben.
    - Het vinkje in `Staged` wordt nu een vierkant en `Status` toont zowel links als rechts "M" (_staged and unstaged modified_).
    - Deze meer complexe situatie leggen we later in detail uit.
    - Voorlopig passen we dit aan door `script1.R` opnieuw te _stagen_. Nu krijgen we terug een vinkje en de linker "M" (_staged modified_)
- _Ignore_ `script1.jpg`
- _Stage_ `script1.png`
- _Stage_ `.gitignore`
- Kijk naar de _Diff_ van `.gitignore`, `script1.jpg` en `script1.R`
- _Commit_ de wijzigingen. 




















### Bestanden wissen en terug zetten naar de laatste commit

- Voer `script1.R` opnieuw uit. Merk op dat er nu niets gebeurd in het `Git` tabblad. Hoewel `script1.png` gewijzigd is, is de inhoud dezelfde gebleven. Een nieuwe versie opslaan is daarom overbodig.
- Wijzig `script1.R` naar onderstaande code, sla het op en voer opnieuw uit

```{r script1_3, eval = FALSE}
library(ggplot2)
p <- ggplot(mtcars, aes(wt, mpg)) + geom_jitter()
ggsave(p, file = "script1.png")
```

- Zowel `script1.R` als `script1.png` zijn nu _unstaged modified_
- Stel dat we `script1.png` niet langer onder versiebeheer wensen.
    - Wis `script1.R` van de harde schijf
    - `script1.R` blijft staan in het `Git` tabblad. De `Status` is nu _unstaged deleted_, aangezien door "D" in een rood veld in de rechter kolom van `Status`.
    - Oeps, we wensten `script1.png` te wissen in plaats van `script1.R`
    - Rechts klik op `script1.R` in het `Git` tabblad en klik op `Revert`. Je krijgt nu een waarschuwing dat eventuele wijzingen verloren gaan. Klik op `Yes`. Git zal nu de versie van `script1.R` uit de laatste commit terug plaatsen. Alle wijzigingen sinds de laatste commit zijn verloren.
    - Wis `script1.png` van de harde schijf.
    - _Stage_ en _commit_ `script1.png`
- Voer `script1.R` opnieuw uit. `script1.png` wordt opnieuw aangemaakt en is nu terug _untracked_.



















## Een bestaand project onder enkel lokaal onder versiebeheer plaatsen

- Open het project in RStudio
- Ga in het menu naar `Tools` -> `Project options`
- Kies het tabblad `Git/SVN`
- Kies `Git` bij `Version control system`
- Bevestig jouw keuze
- Herstart RStudio
- Van nu kan je alle bewerkingen uit voorgaande (en komende) secties toepassen.



















## Branches

- In een eenvoudige git repository staan alle _commits_ achter elkaar in een lange rij.
- git laat toe om op een eenvoudige manier met meerdere _branches_ te werken. Een _branch_ is een vertakking vanaf een bepaald _commit_. Beide _branches_ hebben tot de _commit_ waar ze vertakken dezelfde voorgeschiedenis. Na deze _commit_ kunnen ze elk een andere weg op gaan.
    - Ze gaan elk aan een eigen 'snelheid' verder gaan.
    - Ze zullen een andere inhoud hebben.
    



















### Eenvoudig branching model

- Standaard is er enkel een **master** _branch_.
- Een vaak gebruikte tweede _branch_ is **develop**.
- In dergelijke configuratie bevat **master** de laatste 'officiële' versie.
    - een rapport onder de vorm dat het naar de stuugroep gaat
    - documenten van een les zoals het naar de cursisten gaat
    - een bepaalde versie van een R package
- **develop** bevat dan de versie waar je effectief in werkt.
    - Wanneer de versie in **develop** voldoende uitgekristaliseerd is zullen we die terug invoegen in **master**.
- git laat toe om vlot om te schakelen tussen _branches_.
    - Bij het overschakelen tussen _branches_ worden alle bestanden van de huidige _branch_ vervangen door de bestanden van de (laatste _commit_ van de) nieuwe _branch_.
    - _untracked_ en _ignored_ bestanden blijven behouden.
- je kan met de GUI in het `Git` tabblad enkel wisselen tussen _branches_. Andere bewerking moet je vanaf de command line doen. Klik op het tandwiel icoontje in het `Git` tabblad en kies `Shell...`. Dan krijg je een command line waar je `git` commando's kan ingeven. Alle `git` commando's beginen met `git`.
- We maken een **develop** _branch_ vanaf de huidige _commit_ met `git branch develop`
- Vervolgens maken we **develop** actief met `git checkout develop`
- Met `exit` sluiten we de shell terug.

- Zorg dat de **develop** _branch_ actief is
    - De actieve _branch_ staat rechtsboven aan het `Git` tabblad
- Voeg onderstaande code toe onderaan `script2.R`

```{r script2_1}
library(ggplot2)
ggplot(lm.D9, aes(x = group, y = .resid)) + geom_boxplot()
```

- (_Stage_ en ) _commit_ de wijzigingen aan `script2.R`
- _checkout_ **master**
    - ofwel: in de git shell `git checkout master`
    - ofwel: in het `Git` tabblad klikken op de naam van het huidige _branch_. Kies vervolgens de **master** _brnach_ uit de dropdown lijst
    - Merk op dat de inhoud van `script2.R` terug de vorige versie bevat.
- Ga terug naar de **develop** _branch_
- Voeg in `script2.R` de onderstaande regel toe

```{r script2_2}
ggplot(lm.D9, aes(sample = .stdresid)) + stat_qq() + geom_abline()
```

- _Commit_ deze wijzigingen
- Nu gaan we de wijzigingen in **develop** als een blok toepassen op **master**
    - Ga naar de git shell
    - _Checkout_ de _branch_ naar waar je wenst te _mergen_
        - `git checkout master`
    - _Merge_ **develop** naar **master** zonder _fast-forward_
        - `git merge --no-ff develop`
    - Je krijgt een editor venster waarin je een aangepaste _commit message_ schrijft. Hier beschijft je beknopt de belangrijkste wijzigingen sinds de vorige merge tussen **master** en **develop**
        - Daarom kijk je best EERST naar de _history_ van de **develop** _branch_
- Klik op het uurwerk icoon in het `Git` tabblad. Dit geeft een overzicht van de _history_ van de _repository_.
    - Het bovenste deel toont alle _commits_
        - Je ziet enkel de _commit message_. Vandaar dat het belangrijk is dat de _commit message_ reeds een ruw idee geeft van wat er aangepast is.
        - Tip:  Vaak _committen_ heeft als voordeel dat een beknoptere _commit messages_ volstaat op de wijzigingen te beschrijven.
        - Bij elke _commit_ zie je ook de auteur, date en SHA. Deze laatste is de id van de _commit_
    - Het verband tussen de _commits_ wordt grafisch voorgesteld. 
        - De cirkels zijn de _commits_
        - De lijnen geven het verband tussen de _commits_
        - De oudste _commits_ staan onderaan
        - _Commits_ waaruit twee (of meer) lijnen naar boven vertrekken geven aan dat daar twee _branches_ splitsen.
        - _Commits_ waarin twee lijnen samenkomen geven aan dat de twee _branches_ daar weer _gemerged_ werden.
        - De lijnen en nodes van elke _branch_wordt met een andere kleur weergegeven.
    - Voor sommige _commit messages_ staat de naam van een _branch_. Hiermee wordt de laatste _commit_ van elke _branch_ aangegeven. _HEAD_ is geen _branch_ maar geeft aan welke _commit_ op dit ogenblik actief is. Dit valt in principe samen met de actieve _branch_.
    - Het onderste deel van het scherm geeft aan welke bestanden gewijzigd zijn en wat de _diffs_ weer van de geselecteerde _commit_ ten opzichte van zijn voorgaande _commit_ (de _parent commit_).





















## Een nieuw project op de Stash server plaatsen

## Een bestaand lokaal project op de Stash server plaatsen

## Een repository delen via Stash

## Een project van de Stash server _forken_

## Verplichte lectuur

@Driesen2014 schreef een goede blog post die dieper in gaat over het _branches_.

@Gunther2014 schreef een beknopt boek dat de basis van git op een beknopte manier uitlegt. Het is beschikbaar via de INBO account op Kindle.

@Cottle2014 bied een handige oneline tool om _branching_ onder de knie te kijken. Het is een interactieve website waar je zelf met git commando's aan de slag gaat en dadelijk ziet wat het effect van de commando's op de structuur van de repository is. Elk stapje start met een beknopte uitleg gevolg door een oefening. Er staan veel oefeningen. De website detecteert wanneer je de oefening correct opgelost hebt. Je krijgt dan te zien hoeveel commando's je nodig had en hoeveel commando's hadden kunnen volstaan. Je kan de oefeningen meermaals opnieuw proberen. Als je vastloopt kan je de oplossing vragen. De website is een aanrader als je een beperkte voorkennis hebt. Daarom best eerst @Gunther2014 lezen of de git cursus volgen.

Naast aandacht voor versiebeheer is het ook wenselijk om transparante code te schrijven. Op dat vlak is @Boswell2011 verplichte lectuur. Hoewel geschreven vanuit een C achtergrond, is het prima toepasbaar op R. Ook dit boek is beschikbaar via de INBO account op Kindle.

## _staged and unstaged modified_

- Twee keer "M" bij `Status`

# Referenties
